# We use self-hosted runners for performance: we can rely on docker caching
# on the runner machines for 0s startup times for our tests.
# There is an issue with self-hosted runners where if you use a mix of
# host and container jobs, the host jobs will fail to start
# (https://github.com/actions/checkout/issues/273).
# So we create a separate "builder" tagged runner to do the build job on
# the host, and then all the tests run on "runner" tagged runners.

name: test

on:
  push:

jobs:
  check-which-tests-to-run:
    uses: ./.github/workflows/check-which-tests-to-run.yaml

  weave-ts-sdk-lint:
    name: Weave TS SDK Lint
    runs-on: ubuntu-latest
    needs:
      - check-which-tests-to-run
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Check if lint should run
        id: check_run
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" || "${{ needs.check-which-tests-to-run.outputs.weave_ts_sdk_tests }}" == "true" ]]; then
            echo "Lint should run"
            echo "should_lint=true" >> $GITHUB_OUTPUT
          else
            echo "Lint should not run"
            echo "should_lint=false" >> $GITHUB_OUTPUT
          fi
      - uses: pnpm/action-setup@v4
        with:
          version: 10.8.1
      - name: Run Weave TS SDK Lint
        if: steps.check_run.outputs.should_lint == 'true'
        run: |
          cd sdks/node
          pnpm install --frozen-lockfile
          pnpm run prettier-check

  # ==== Trace Jobs ====
  lint:
    name: Python lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nox uv
      - name: Run nox
        run: nox -e lint

  trace-tests:
    name: Trace nox tests
    uses: ./.github/workflows/reusable-trace-tests.yaml
    with:
      job_name: Trace nox tests
      timeout_minutes: 15
      python_version_minors_json: '["10", "11", "13"]'
      shards_json: '["trace_no_server", "trace", "trace_calls_complete_only", "flow", "trace_server", "trace_server_bindings", "anthropic", "bedrock", "cerebras", "cohere", "crewai", "dspy", "groq", "google_genai", "instructor", "langchain", "litellm", "llamaindex", "mistral", "notdiamond", "openai", "openai_agents", "verifiers_test", "vertexai", "pandas_test", "mcp", "smolagents", "autogen_tests"]'
      marker_filter_enabled: false
      non_trace_server_shards_json: '["trace_no_server"]'
      use_heavy_runner: true
      clickhouse_image: clickhouse/clickhouse-server:25.11.2.24
      set_weave_use_memray: false
      use_dummy_api_key_fallback: true
      upload_coverage: true
      coverage_flag: trace-tests
      coverage_name_prefix: trace-tests
    secrets: inherit
  trace-tests-matrix-check: # This job does nothing and is only used for the branch protection
    if: always()

    needs:
      - trace-tests

    runs-on: ubuntu-latest

    steps:
      - name: Passes if all trace-tests jobs succeeded
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}

  # ==== Windows Jobs ====
  windows_trace_tests:
    name: Trace nox tests (windows)
    uses: ./.github/workflows/reusable-trace-tests-windows.yaml
    with:
      job_name: Trace nox tests (windows)
      timeout_minutes: 15
      python_version_minors_json: '["10", "11", "13"]'
      shards_json: '["trace_no_server", "trace", "flow", "trace_server", "trace_server_bindings", "anthropic", "bedrock", "cerebras", "cohere", "crewai", "dspy", "groq", "google_genai", "instructor", "langchain", "litellm", "llamaindex", "mistral", "notdiamond", "openai", "verifiers_test", "vertexai", "pandas_test", "mcp", "smolagents", "autogen_tests"]'
      non_trace_server_shards_json: '["trace_no_server"]'
      upload_coverage: true
    secrets: inherit

  windows-trace-tests-matrix-check: # This job does nothing and is only used for the branch protection
    if: always()

    needs:
      - windows_trace_tests

    runs-on: ubuntu-latest

    steps:
      - name: Passes if all windows_trace_tests jobs succeeded
        uses: re-actors/alls-green@release/v1
        with:
          jobs: ${{ toJSON(needs) }}
