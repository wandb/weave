name: nightly-tests

on:
  schedule:
    # Run at midnight UTC
    - cron: "0 0 * * *"
  # Allow manual triggering
  workflow_dispatch:

jobs:
  scorers-tests:
    name: Nightly Scorers Tests
    timeout-minutes: 30
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version-major: ["3"]
        python-version-minor: [
            "9",
            "10",
            "11",
            "12",
            "13",
            #
          ]
      fail-fast: false
    services:
      wandbservice:
        image: us-central1-docker.pkg.dev/wandb-production/images/local-testcontainer:master
        credentials:
          username: _json_key
          password: ${{ secrets.gcp_wb_sa_key }}
        env:
          CI: 1
          WANDB_ENABLE_TEST_CONTAINER: true
          LOGGING_ENABLED: true
        ports:
          - "8080:8080"
          - "8083:8083"
          - "9015:9015"
        options: >-
          --health-cmd "wget -q -O /dev/null http://localhost:8080/healthz || exit 1"
          --health-interval=5s
          --health-timeout=3s
          --health-start-period=10s
      weave_clickhouse:
        image: clickhouse/clickhouse-server
        env:
          CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: 1
          CLICKHOUSE_USER: default
          CLICKHOUSE_PASSWORD: ""
          CLICKHOUSE_DB: default
        ports:
          - "8123:8123"
        options: --health-cmd "wget -nv -O- 'http://localhost:8123/ping' || exit 1" --health-interval=5s --health-timeout=3s
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Enable debug logging
        run: echo "ACTIONS_STEP_DEBUG=true" >> $GITHUB_ENV
      - name: Install SQLite dev package
        run: sudo apt update && sudo apt install -y libsqlite3-dev
      - name: Set up Python ${{ matrix.python-version-major }}.${{ matrix.python-version-minor }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version-major }}.${{ matrix.python-version-minor }}
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install nox uv
      - name: Run scorers tests
        env:
          WEAVE_SENTRY_ENV: ci
          CI: 1
          WB_SERVER_HOST: http://wandbservice
          WF_CLICKHOUSE_HOST: weave_clickhouse
          WEAVE_SERVER_DISABLE_ECOSYSTEM: 1
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MISTRAL_API_KEY: ${{ secrets.MISTRAL_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DD_TRACE_ENABLED: false
        run: |
          nox -e "tests-${{ matrix.python-version-major }}.${{ matrix.python-version-minor }}(shard='scorers')"
