name: nightly-tests

on:
  schedule:
    # Run at midnight UTC
    - cron: "0 0 * * *"
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      shards:
        description: "Comma-separated list of shards to run (leave empty for all)"
        required: false
        default: ""

jobs:
  nightly-tests:
    name: Nightly Tests
    uses: ./.github/workflows/reusable-trace-tests.yaml
    with:
      job_name: Nightly Tests
      timeout_minutes: 30
      python_version_minors_json: '["10", "11", "12", "13"]'
      shards_json: '["trace", "flow", "trace_server", "trace_server_bindings", "anthropic", "bedrock", "cerebras", "cohere", "crewai", "dspy", "groq", "google_genai", "instructor", "langchain", "litellm", "llamaindex", "mistral", "notdiamond", "openai", "verifiers_test", "vertexai", "pandas_test", "mcp", "smolagents", "autogen_tests"]'
      shard_filter: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.shards || '' }}
      marker_filter_enabled: true
      use_heavy_runner: false
      clickhouse_image: clickhouse/clickhouse-server:25.10
      set_weave_use_memray: true
      use_dummy_api_key_fallback: false
      upload_coverage: false
    secrets: inherit

  slack-notification:
    name: Slack Notification
    needs:
      - nightly-tests

    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Determine Result and Failed Jobs
        id: result
        env:
          NEEDS: "${{ toJson(needs) }}"
        run: |
          jq -C . <<< "${NEEDS}" # debug

          # Check if any job failed
          has_failure=$(
            jq -r '
              .[]
              | select(.result == "failure")
              | "true"
            ' <<< "${NEEDS}" | head -n1
          )

          if [ "$has_failure" = "true" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            
            failed_jobs=$(
              jq -r '
                to_entries
                | [
                  .[]
                  | select(.value.result == "failure")
                  | .key
                ]
                | join(", ")
              ' <<< "${NEEDS}"
            )
            echo "failed_jobs=$failed_jobs" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack Notification on Failure
        if: steps.result.outputs.status == 'failure'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "C09CE03J867"
          slack-message: |
            <!subteam^S06HYJNN7SL> :x: Nightly Tests failed!
            *Repository:* ${{ github.repository }}
            *Commit:* ${{ github.sha }}
            *Failed Jobs:* ${{ steps.result.outputs.failed_jobs }}
            *Build:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.WANDB_CI_SLACK_BOT_TOKEN }}

      - name: Send Slack Notification on Success
        if: steps.result.outputs.status == 'success'
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: "C09CE03J867"
          slack-message: |
            :white_check_mark: Nightly Tests passed!
            *Repository:* ${{ github.repository }}
            *Commit:* ${{ github.sha }}
            *Build:* ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.WANDB_CI_SLACK_BOT_TOKEN }}
