"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[3539],{56733:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>s,metadata:()=>l,toc:()=>a});var i=t(85893),r=t(11151);const s={},o="Model Context Protocol (MCP) and Weave",l={id:"guides/integrations/mcp",title:"Model Context Protocol (MCP) and Weave",description:"The Model Context Protocol (MCP) is a standardized communication protocol that enables AI applications to exchange information with large language models (LLMs). Similar to universal connectors that transformed hardware compatibility, MCP provides an interface for LLMs to access various data sources and interact with external tools, all without requiring custom integrations for each new service.",source:"@site/docs/guides/integrations/mcp.md",sourceDirName:"guides/integrations",slug:"/guides/integrations/mcp",permalink:"/guides/integrations/mcp",draft:!1,unlisted:!1,editUrl:"https://github.com/wandb/weave/blob/master/docs/docs/guides/integrations/mcp.md",tags:[],version:"current",lastUpdatedAt:1749652482e3,frontMatter:{},sidebar:"documentationSidebar",previous:{title:"Integrations",permalink:"/guides/integrations/"},next:{title:"Platform & Security",permalink:"/guides/platform/"}},c={},a=[{value:"How it works",id:"how-it-works",level:2},{value:"Use the integration",id:"use-the-integration",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Configuration",id:"configuration",level:3},{value:"Server-side integration",id:"server-side-integration",level:3},{value:"Client-side integration",id:"client-side-integration",level:3},{value:"Tutorial: <code>mcp_demo</code> example",id:"tutorial-mcp_demo-example",level:2},{value:"Run the example",id:"run-the-example",level:3},{value:"Client CLI commands",id:"client-cli-commands",level:3},{value:"Understanding the example",id:"understanding-the-example",level:3},{value:"FAQ",id:"faq",level:2},{value:"Why is MCP tracing needed?",id:"why-is-mcp-tracing-needed",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"model-context-protocol-mcp-and-weave",children:"Model Context Protocol (MCP) and Weave"}),"\n",(0,i.jsx)("a",{target:"_blank",href:"https://colab.research.google.com/drive/174VzXlU5Qcgvjt4OoIWN-guTxJcOefAh?usp=sharing",children:(0,i.jsx)("img",{src:"https://colab.research.google.com/assets/colab-badge.svg",alt:"Open In Colab"})}),"\n",(0,i.jsx)(n.p,{children:"The Model Context Protocol (MCP) is a standardized communication protocol that enables AI applications to exchange information with large language models (LLMs). Similar to universal connectors that transformed hardware compatibility, MCP provides an interface for LLMs to access various data sources and interact with external tools, all without requiring custom integrations for each new service."}),"\n",(0,i.jsx)(n.p,{children:"The Weave integration lets you trace activity between your MCP client and MCP server. It gives you detailed visibility into tool calls, resource access, and prompt generation across MCP-based systems."}),"\n",(0,i.jsx)(n.h2,{id:"how-it-works",children:"How it works"}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["Currently, the integration captures client-side and server-side operations separately, but does not provide end-to-end visibility into their interaction. There's an ongoing proposal to add OpenTelemetry trace support to MCP to enable end-to-end observability. For more information, see ",(0,i.jsx)(n.a,{href:"https://github.com/modelcontextprotocol/modelcontextprotocol/discussions/269",children:"GitHub discussion #269"}),"."]})}),"\n",(0,i.jsxs)(n.p,{children:["The Weave integration automatically traces key components of the Model Context Protocol (MCP) by patching core methods with the ",(0,i.jsx)(n.a,{href:"/guides/tracking/ops",children:(0,i.jsx)(n.code,{children:"weave.op()"})})," decorator. Specifically, it patches methods in the ",(0,i.jsx)(n.a,{href:"https://github.com/modelcontextprotocol/python-sdk/blob/b4c7db6a50a5c88bae1db5c1f7fba44d16eebc6e/src/mcp/server/fastmcp/server.py#L109",children:(0,i.jsx)(n.code,{children:"mcp.server.fastmcp.FastMCP"})})," and ",(0,i.jsx)(n.a,{href:"https://github.com/modelcontextprotocol/python-sdk/blob/b4c7db6a50a5c88bae1db5c1f7fba44d16eebc6e/src/mcp/client/session.py#L84",children:(0,i.jsx)(n.code,{children:"mcp.ClientSession"})})," classes."]}),"\n",(0,i.jsx)(n.p,{children:"Through this integration, Weave traces the following MCP components:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://modelcontextprotocol.io/docs/concepts/tools",children:"Tools"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://modelcontextprotocol.io/docs/concepts/resources",children:"Resources"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://modelcontextprotocol.io/docs/concepts/prompts",children:"Prompts"})}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.a,{href:"https://wandb.ai/ayut/mcp_example/weave/traces?filter=%7B%22opVersionRefs%22%3A%5B%22weave%3A%2F%2F%2Fayut%2Fmcp_example%2Fop%2Frun_client%3A*%22%5D%7D&peekPath=%2Fayut%2Fmcp_example%2Fcalls%2F01966bbe-cc5e-7012-b45f-bf10617d8c1e%3FhideTraceTree%3D0",children:(0,i.jsx)(n.img,{alt:"mcp_trace_timeline.png",src:t(97374).Z+"",width:"3801",height:"2339"})})}),"\n",(0,i.jsx)(n.h2,{id:"use-the-integration",children:"Use the integration"}),"\n",(0,i.jsxs)(n.p,{children:["The Weave integration works with both the MCP server and client. Once installed, you can enable tracing with just two additional lines of code\u2014one to import ",(0,i.jsx)(n.code,{children:"weave"}),", and another to initialize it."]}),"\n",(0,i.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,i.jsx)(n.p,{children:"Before you begin, install the required packages:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'pip install -qq "mcp[cli]" weave\n'})}),"\n",(0,i.jsx)(n.h3,{id:"configuration",children:"Configuration"}),"\n",(0,i.jsx)(n.p,{children:"The MCP integration can be configured through environment variables:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"MCP_TRACE_LIST_OPERATIONS"}),": Set to ",(0,i.jsx)(n.code,{children:"true"})," to trace list operations (",(0,i.jsx)(n.code,{children:"list_tools"}),", ",(0,i.jsx)(n.code,{children:"list_resources"}),", and ",(0,i.jsx)(n.code,{children:"list_prompts"}),") on both server and client sides."]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"server-side-integration",children:"Server-side integration"}),"\n",(0,i.jsxs)(n.p,{children:["To trace an MCP server, add two lines to your existing ",(0,i.jsx)(n.code,{children:"FastMCP"})," setup: one to import Weave and one to initialize the client. Once added, tool, resource, and prompt operations will be automatically traced."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Import Weave (required for tracing)\nimport weave\nfrom mcp.server.fastmcp import FastMCP\n\n# Initialize Weave with your project name\nweave_client = weave.init("my-project")\n\n# Set up the MCP server\nmcp = FastMCP("Demo")\n\n# Define a tool (this call will be traced)\n@mcp.tool()\ndef add(a: int, b: int) -> int:\n    """Add two numbers."""\n    return a + b\n\n# Define a resource (this call will be traced)\n@mcp.resource("greeting://{name}")\ndef get_greeting(name: str) -> str:\n    """Return a personalized greeting."""\n    return f"Hello, {name}!"\n\n# Define a prompt (this call will be traced)\n@mcp.prompt()\ndef review_code(code: str) -> str:\n    """Return a prompt for reviewing code."""\n    return f"Please review this code:\\n\\n{code}"\n\n# Start the server\nmcp.run(transport="stdio")\n'})}),"\n",(0,i.jsx)(n.h3,{id:"client-side-integration",children:"Client-side integration"}),"\n",(0,i.jsx)(n.p,{children:"On the client side, tracing also requires just two changes: import Weave and initialize it. All tool calls, resource accesses, and prompt requests will be traced automatically."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'# Import Weave (required for tracing)\nimport weave\nfrom mcp import ClientSession, StdioServerParameters\nfrom mcp.client.stdio import stdio_client\n\n# Initialize Weave with your project name\nweave_client = weave.init("my-project")\n\n# Set up and run the MCP client\nasync with stdio_client(server_params) as (read, write):\n    async with ClientSession(read, write) as session:\n        # Initialize the session\n        await session.initialize()\n        \n        # Call a tool (this will be traced)\n        result = await session.call_tool("add", arguments={"a": 1, "b": 2})\n        \n        # Read a resource (this will be traced)\n        resource = await session.read_resource("greeting://user")\n        \n        # Get a prompt (this will be traced)\n        prompt = await session.get_prompt("review_code", arguments={"code": "print(\'Hello\')"})\n'})}),"\n",(0,i.jsxs)(n.h2,{id:"tutorial-mcp_demo-example",children:["Tutorial: ",(0,i.jsx)(n.code,{children:"mcp_demo"})," example"]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.a,{href:"https://github.com/wandb/weave/tree/master/examples/mcp_demo",children:(0,i.jsx)(n.code,{children:"mcp_example"})})," demonstrates an integration between the Model Context Protocol (MCP) and Weave for tracing. It showcases how to instrument both the client and server components to capture detailed traces of their interactions."]}),"\n",(0,i.jsx)(n.h3,{id:"run-the-example",children:"Run the example"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Clone the ",(0,i.jsx)(n.code,{children:"weave"})," repository and navigate to the ",(0,i.jsx)(n.code,{children:"mcp_demo"})," example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"git clone https://github.com/wandb/weave\ncd weave/examples/mcp_demo\n"})}),"\n",(0,i.jsx)(n.p,{children:"The example includes two main files:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"example_server.py"}),": A demo MCP server built with ",(0,i.jsx)(n.code,{children:"FastMCP"}),". It defines tools, resources, and prompts."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"example_client.py"}),": A client that connects to the server and interacts with its components."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Install the required dependencies manually:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"pip install mcp[cli] weave\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Run the demo:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"python example_client.py example_server.py\n"})}),"\n",(0,i.jsx)(n.p,{children:"This command launches both the client and server. The client starts an interactive CLI where you can test various features."}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"client-cli-commands",children:"Client CLI commands"}),"\n",(0,i.jsx)(n.p,{children:"The client interface supports the following commands:"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Command"}),(0,i.jsx)(n.th,{children:"Description"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"tools"})}),(0,i.jsx)(n.td,{children:"List available tools"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"resources"})}),(0,i.jsx)(n.td,{children:"List available resources"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"prompts"})}),(0,i.jsx)(n.td,{children:"List available prompts"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"add <a> <b>"})}),(0,i.jsx)(n.td,{children:"Add two numbers"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"bmi <weight> <height>"})}),(0,i.jsx)(n.td,{children:"Calculate Body Mass Index"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"weather <city>"})}),(0,i.jsx)(n.td,{children:"Get weather data for a city"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"greeting <name>"})}),(0,i.jsx)(n.td,{children:"Get a personalized greeting"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"user <id>"})}),(0,i.jsx)(n.td,{children:"Retrieve a user profile"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"config"})}),(0,i.jsx)(n.td,{children:"Fetch app configuration"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"code-review <code>"})}),(0,i.jsx)(n.td,{children:"Generate a code review prompt"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"debug <error>"})}),(0,i.jsx)(n.td,{children:"Generate a debugging prompt"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"demo"})}),(0,i.jsx)(n.td,{children:"Run a full demo of all available features. This will run each feature in sequence and produce a full trace timeline of interactions in the Weave UI."})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"q"})}),(0,i.jsx)(n.td,{children:"Quit the session"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"understanding-the-example",children:"Understanding the example"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"example_server.py"})," server defines the following:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"Tools"}),": Functions such as ",(0,i.jsx)(n.code,{children:"add()"}),", ",(0,i.jsx)(n.code,{children:"calculate_bmi()"}),", ",(0,i.jsx)(n.code,{children:"fetch_weather()"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"Resources"}),": Endpoints like ",(0,i.jsx)(n.code,{children:"greeting://{name}"}),", ",(0,i.jsx)(n.code,{children:"config://app"}),", ",(0,i.jsx)(n.code,{children:"users://{id}/profile"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.em,{children:"Prompts"}),": Templates like ",(0,i.jsx)(n.code,{children:"review_code()"})," and ",(0,i.jsx)(n.code,{children:"debug_error()"})]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["All server-side operations are automatically traced by Weave when you initialize the client with ",(0,i.jsx)(n.code,{children:"weave.init()"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"example_client.py"})," client demonstrates how to:"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Connect to an MCP server"}),"\n",(0,i.jsx)(n.li,{children:"Discover available tools, resources, and prompts"}),"\n",(0,i.jsx)(n.li,{children:"Call tools with parameters"}),"\n",(0,i.jsx)(n.li,{children:"Read from resource URIs"}),"\n",(0,i.jsx)(n.li,{children:"Generate prompts with arguments"}),"\n",(0,i.jsxs)(n.li,{children:["Show usage of ",(0,i.jsx)(n.a,{href:"/guides/tracking/ops",children:(0,i.jsx)(n.code,{children:"weave.op()"})})," with custom methods/functions."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Weave traces all client-side calls to provide a complete view of interactions between the client and server."}),"\n",(0,i.jsx)(n.h2,{id:"faq",children:"FAQ"}),"\n",(0,i.jsx)(n.h3,{id:"why-is-mcp-tracing-needed",children:"Why is MCP tracing needed?"}),"\n",(0,i.jsx)(n.p,{children:"As an LLM application developer, you fall into one of three categories:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"MCP server-side developer"}),": You want to expose multiple tools, resources, and prompts to the MCP client. You expose your existing application's tools, resources, etc., or you have built agents or have multiple agents orchestrated by an orchestrator agent."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"MCP client-side developer"}),": You want to plug your client-side application into multiple MCP servers. A core part of your client-side logic is making LLM calls to decide which tool to call or which resource to fetch."]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.em,{children:"MCP server and client developer"}),": You are developing both the server and the client."]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"If you fall into either of the first two categories, you want to know when each tool is called, what the execution flow looks like, the token count, and latency of different components in your server or client-side logic."}),"\n",(0,i.jsx)(n.p,{children:"If you are developing both the server and client, the ability to see a unified trace timeline can help you quickly iterate through both server and client-side logic."}),"\n",(0,i.jsx)(n.p,{children:"In any case, an observability layer allows you to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Quickly iterate through your application"}),"\n",(0,i.jsx)(n.li,{children:"Audit the workflow or execution logic"}),"\n",(0,i.jsx)(n.li,{children:"Identify bottlenecks"}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},97374:(e,n,t)=>{t.d(n,{Z:()=>i});const i=t.p+"assets/images/mcp_trace_timeline-204327d4cc77ffb82ddba6f45e360298.png"},11151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>o});var i=t(67294);const r={},s=i.createContext(r);function o(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);