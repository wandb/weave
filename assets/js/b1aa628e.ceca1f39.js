"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5625],{63932:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var t=s(85893),i=s(11151);const a={},o="W&B Weave Self-Managed",r={id:"guides/platform/weave-self-managed",title:"W&B Weave Self-Managed",description:"Self-hosting W&B Weave allows you have more control over its environment and configuration. This can be helpful for use cases that require isolation and additional security compliance. This guide explains how to deploy all the components required to run W&B Weave in a self-managed environment.",source:"@site/docs/guides/platform/weave-self-managed.md",sourceDirName:"guides/platform",slug:"/guides/platform/weave-self-managed",permalink:"/guides/platform/weave-self-managed",draft:!1,unlisted:!1,editUrl:"https://github.com/wandb/weave/blob/master/docs/docs/guides/platform/weave-self-managed.md",tags:[],version:"current",lastUpdatedAt:1758909243e3,frontMatter:{},sidebar:"documentationSidebar",previous:{title:"Platform & Security",permalink:"/guides/platform/"},next:{title:"Environment variables",permalink:"/guides/core-types/env-vars"}},l={},c=[{value:"Requirements",id:"requirements",level:2},{value:"1. Deploy ClickHouse",id:"1-deploy-clickhouse",level:2},{value:"Configure Helm repository",id:"configure-helm-repository",level:3},{value:"Install Altinity Operator:",id:"install-altinity-operator",level:3},{value:"Configure bucket access/secret credentials:",id:"configure-bucket-accesssecret-credentials",level:3},{value:"Deploy keeper into Kubernetes cluster:",id:"deploy-keeper-into-kubernetes-cluster",level:3},{value:"Deploy ch-server into the Kubernetes cluster:",id:"deploy-ch-server-into-the-kubernetes-cluster",level:3},{value:"Confirm ClickHouse deployment",id:"confirm-clickhouse-deployment",level:3},{value:"2. Add ClickHouse Configuration in W&amp;B Platform CR",id:"2-add-clickhouse-configuration-in-wb-platform-cr",level:2},{value:"3. Access Weave",id:"3-access-weave",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"wb-weave-self-managed",children:"W&B Weave Self-Managed"}),"\n",(0,t.jsx)(n.p,{children:"Self-hosting W&B Weave allows you have more control over its environment and configuration. This can be helpful for use cases that require isolation and additional security compliance. This guide explains how to deploy all the components required to run W&B Weave in a self-managed environment."}),"\n",(0,t.jsxs)(n.p,{children:["Self-managed Weave deployments rely on ",(0,t.jsx)(n.a,{href:"https://clickhouse.com/",children:"ClickHouseDB"})," to manage its backend. Although the deployment process sets up a fully functional ClickHouseDB instance, you may need to take additional steps to ensure reliability and high availability for a production-ready environment."]}),"\n",(0,t.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,t.jsx)(n.p,{children:"Setting up a self-managed instance of Weave requires:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/hosting-options/self-managed/",children:"W&B Platform installed"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.a,{href:"https://docs.altinity.com/altinitykubernetesoperator",children:"Altinity Kubernetes Operator for ClickHouse"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["An S3 bucket pre-configured for ClickHouse storage. For configuration details, see ",(0,t.jsx)(n.a,{href:"#provide-s3-credentials",children:"Provide S3 Credentials"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["A Kubernetes cluster node with the following specifications:","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"CPU: 8 cores"}),"\n",(0,t.jsx)(n.li,{children:"RAM: 64 GB"}),"\n",(0,t.jsx)(n.li,{children:"Disk: 200GB+"}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["A Weave-enabled license from W&B. To request a license, contact ",(0,t.jsx)(n.code,{children:"support@wandb.com"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{type:"tip",children:[(0,t.jsx)(n.mdxAdmonitionTitle,{}),(0,t.jsxs)(n.p,{children:["For a detailed reference architecture, see ",(0,t.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/self-managed/ref-arch/#models-and-weave",children:"https://docs.wandb.ai/guides/hosting/self-managed/ref-arch/"}),"."]})]}),"\n",(0,t.jsx)(n.h2,{id:"1-deploy-clickhouse",children:"1. Deploy ClickHouse"}),"\n",(0,t.jsxs)(n.p,{children:["The ClickHouse deployment in this guide uses the ",(0,t.jsx)(n.a,{href:"https://docs.altinity.com/altinitykubernetesoperator",children:"Altinity Kubernetes Operator for ClickHouse"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["Altinity uses operator to install, configure, and run a ClickHouse cluster in a Kubernetes cluster, including setting up persistent storage and replication. See the ",(0,t.jsx)(n.a,{href:"https://github.com/Altinity/clickhouse-operator",children:"ClickHouse Operator repo"})," for in-depth technical details and ",(0,t.jsx)(n.a,{href:"https://github.com/Altinity/clickhouse-operator/tree/master/docs#table-of-contents",children:"advanced configuration"}),"."]}),"\n",(0,t.jsx)(n.h3,{id:"configure-helm-repository",children:"Configure Helm repository"}),"\n",(0,t.jsx)(n.p,{children:"To begin deploying ClickHouse:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Add the Altinity Helm repository:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"helm repo add altinity https://helm.altinity.com"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Update the helm repository:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"helm repo update"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"install-altinity-operator",children:"Install Altinity Operator:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"helm install ch-operator altinity/clickhouse --namespace clickhouse --create-namespace --version 0.2.6"})}),"\n",(0,t.jsx)(n.h3,{id:"configure-bucket-accesssecret-credentials",children:"Configure bucket access/secret credentials:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'# Create secret in clickhouse namespace with bucket secret\n SECRET_NAME="ch-bucket-cred"\n NAMESPACE="clickhouse"\n ACCESS_ID=# Get ACCESS_ID and SECRET from bucket\n kubectl -n "$NAMESPACE" create secret generic "$SECRET_NAME" \\\n --from-literal=access_key="$ACCESS_ID" \\\n --from-literal=secret_key="$SECRET" \\\n --dry-run=client -o yaml | kubectl apply -f -\n'})}),"\n",(0,t.jsx)(n.h3,{id:"deploy-keeper-into-kubernetes-cluster",children:"Deploy keeper into Kubernetes cluster:"}),"\n",(0,t.jsxs)(n.p,{children:["Customize the ",(0,t.jsx)(n.code,{children:"storageClassName"})," paramater in the following configuration and then run:"]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f ch-keeper.yaml -n clickhouse"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'apiVersion: "clickhouse-keeper.altinity.com/v1"\nkind: "ClickHouseKeeperInstallation"\nmetadata:\n name: wandb\n annotations: {}\nspec:\n # Default templates for all clusters\n # I\'m using specific templates, but we can move all configuration\n # to default templates and suppress the templates section in the cluster configuration\n defaults:\n   templates:\n     podTemplate: default\n     dataVolumeClaimTemplate: default\n\n # Clickhouse Keeper cluster templates\n templates:\n   podTemplates:\n     - name: keeper\n       metadata:\n         annotations: {}\n         labels:\n           app: clickhouse-keeper\n       spec:\n         # Pod security context: Need to set for OpenShift\n         # securityContext:\n         #   runAsNonRoot: true\n         #   runAsUser: 101 # Your OpenShift user ID\n         #   runAsGroup: 0\n         #   fsGroup: 101 # Your OpenShift user ID\n         #   fsGroupChangePolicy: "Always"\n         #   seccompProfile:\n         #     type: "RuntimeDefault"\n\n         # Recommended for multiple nodes\n         affinity:\n           podAntiAffinity:\n             requiredDuringSchedulingIgnoredDuringExecution:\n               - labelSelector:\n                   matchExpressions:\n                     - key: "app"\n                       operator: In\n                       values:\n                         - clickhouse-keeper\n                 topologyKey: "kubernetes.io/hostname"\n\n         # Container configuration\n         containers:\n           - name: clickhouse-keeper\n             imagePullPolicy: IfNotPresent\n             image: "clickhouse/clickhouse-keeper:25.3.5.42"\n             resources:\n               requests:\n                 memory: "256M"\n                 cpu: "1"\n               limits:\n                 memory: "4Gi"\n                 cpu: "2"\n\n             # Container security context: Need to set for OpenShift\n             # securityContext:\n             #   allowPrivilegeEscalation: false\n             #   capabilities:\n             #     drop:\n             #       - ALL\n             #     add:\n             #       - NET_ADMIN\n             #   privileged: false\n             #   readOnlyRootFilesystem: false\n\n   # Data volume claim template\n   volumeClaimTemplates:\n     - name: data\n       metadata:\n         labels:\n           app: clickhouse-keeper\n       spec:\n         storageClassName: standard-rwo # Replace with your storage class\n         accessModes:\n           - ReadWriteOnce\n         resources:\n           requests:\n             storage: 10Gi\n\n # CliCkhouse Keeper cluster configuration\n configuration:\n   clusters:\n     - name: keeper\n       layout:\n         replicasCount: 3\n       # Templates for the cluster (not the default templates)\n       templates:\n         podTemplate: keeper\n         dataVolumeClaimTemplate: data\n\n   # For details, see:\n   # https://clickhouse.com/docs/guides/sre/keeper/clickhouse-keeper#configuration\n   settings:\n     logger/level: "information"\n     logger/console: "true"\n     listen_host: "0.0.0.0"\n     keeper_server/four_letter_word_white_list: "*"\n     keeper_server/coordination_settings/raft_logs_level: "information"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"deploy-ch-server-into-the-kubernetes-cluster",children:"Deploy ch-server into the Kubernetes cluster:"}),"\n",(0,t.jsx)(n.p,{children:"Customize the following fields in the following configuration as needed:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Update ",(0,t.jsx)(n.code,{children:"storageClassName"})]}),"\n",(0,t.jsxs)(n.li,{children:["Update node endpoints ",(0,t.jsx)(n.code,{children:"<zookeeperpod>.<namespace>.svc.cluster.local"})]}),"\n",(0,t.jsxs)(n.li,{children:["Update host endpoints ",(0,t.jsx)(n.code,{children:"<host><clickhouse-pod>.<namespace>.svc.cluster.local</host>"})]}),"\n",(0,t.jsxs)(n.li,{children:["Update ",(0,t.jsx)(n.code,{children:"storage_configuration"})]}),"\n",(0,t.jsx)(n.li,{children:"Sizes of cache and other filesystems"}),"\n",(0,t.jsxs)(n.li,{children:["Password for ",(0,t.jsx)(n.code,{children:"weave"})," user"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"Once you've updated your fields, apply the changes:"}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.code,{children:"kubectl apply -f ch-server.yaml -n clickhouse"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'apiVersion: "clickhouse.altinity.com/v1"\nkind: "ClickHouseInstallation"\nmetadata:\n  name: wandb\n  annotations: {}\nspec:\n  # Default templates for all clusters\n  # I\'m using specific templates, but we can move all configuration\n  # to default templates and suppress the templates section in the cluster configuration\n  defaults:\n    templates:\n      podTemplate: default\n      dataVolumeClaimTemplate: default\n\n  templates:\n    podTemplates:\n      - name: clickhouse\n        metadata:\n          annotations: {}\n          labels:\n            app: clickhouse-server\n        spec:\n          # Pod security context: Need to set for OpenShift\n          # securityContext:\n          #   runAsNonRoot: true\n          #   runAsUser: 101 # Your OpenShift user ID\n          #   runAsGroup: 0\n          #   fsGroup: 101 # Your OpenShift user ID\n          #   fsGroupChangePolicy: "Always"\n          #   seccompProfile:\n          #     type: "RuntimeDefault"\n\n          # Recommended for multiple nodes\n          affinity:\n            podAntiAffinity:\n              requiredDuringSchedulingIgnoredDuringExecution:\n                - labelSelector:\n                    matchExpressions:\n                      - key: "app"\n                        operator: In\n                        values:\n                          - clickhouse-server\n                  topologyKey: "kubernetes.io/hostname"\n\n          containers:\n            - name: clickhouse\n              image: clickhouse/clickhouse-server:25.3.5.42\n              resources:\n                requests:\n                  memory: 2Gi\n                  cpu: 1\n                limits:\n                  memory: 16Gi\n                  cpu: 2\n              # If you want to use AWS credentials, you can use the following:\n              #env:\n              #  - name: AWS_ACCESS_KEY_ID\n              #    valueFrom:\n              #      secretKeyRef:\n              #        name: ch-bucket-cred\n              #        key: access_key\n              #  - name: AWS_SECRET_ACCESS_KEY\n              #    valueFrom:\n              #      secretKeyRef:\n              #        name: ch-bucket-cred\n              #        key: secret_key\n\n              # Container security context: Need to set for OpenShift\n              # securityContext:\n              #   allowPrivilegeEscalation: false\n              #   capabilities:\n              #     drop:\n              #       - ALL\n              #     add:\n              #       - NET_ADMIN\n              #   privileged: false\n              #   readOnlyRootFilesystem: false\n\n    volumeClaimTemplates:\n      - name: data\n        metadata:\n          labels:\n            app: clickhouse-server\n        spec:\n          accessModes:\n            - ReadWriteOnce\n          resources:\n            requests:\n              storage: 50Gi\n          storageClassName: standard-rwo\n\n  configuration:\n    # Refer to: https://clickhouse.com/docs/operations/server-configuration-parameters/settings#zookeeper\n    zookeeper:\n      nodes:\n        - host: chk-wandb-keeper-0-0-0.clickhouse.svc.cluster.local # Set zookeeper node endpoints\n          port: 2181\n        - host: chk-wandb-keeper-0-1-0.clickhouse.svc.cluster.local # Set zookeeper node endpoints\n          port: 2181\n        - host: chk-wandb-keeper-0-2-0.clickhouse.svc.cluster.local # Set zookeeper node endpoints\n          port: 2181\n      # Other configurations\n      # session_timeout_ms: 30000\n      # operation_timeout_ms: 10000\n\n    # Users configuration: https://clickhouse.com/docs/operations/configuration-files#user-settings\n    # Tip for password :\n    # sha256sum <<< weave123 OR echo -n weave123 | sha256sum OR printf "weave123" | sha256sum\n    # It wil turn into <password_sha256_hex>...</password_sha256_hex> in user config\n    users:\n      weave/password:   # to use k8s secrets for "weave" user password\n        valueFrom:\n          secretKeyRef:\n            name: <db-password>\n            key: <password>\n      weave/access_management: 1\n      weave/profile: default\n      weave/networks/ip:\n        - 0.0.0.0/0\n\n    # Settings configuration: https://clickhouse.com/docs/operations/server-configuration-parameters/settings\n    # This can be here or in a config file\n    settings:\n      {}\n      # prometheus/metrics: 1\n      # prometheus/endpoint: /metrics\n      # prometheus/port: 9191\n      # prometheus/events: 1\n      # prometheus/asynchronous_metrics: 1\n\n    clusters:\n      - name: clickhouse\n        layout:\n          shardsCount: 1\n          replicasCount: 3\n        templates:\n          podTemplate: clickhouse\n          dataVolumeClaimTemplate: data\n\n    files:\n      config.d/network_configuration.xml: |\n        <clickhouse>\n            <network_configuration>\n                <listen_host>0.0.0.0</listen_host>\n                <listen_host>::</listen_host>\n            </network_configuration>\n        </clickhouse>\n      config.d/logger.xml: |\n        <clickhouse>\n            <logger>\n                <level>information</level>\n            </logger>\n        </clickhouse>\n      config.d/remote_servers.xml: |\n        <clickhouse>\n          <remote_servers>\n            <weave_cluster>\n              <shard>\n                <replica>\n                  <host>chi-wandb-clickhouse-0-0.clickhouse.svc.cluster.local</host> # Update shard replica host\n                  <port>9000</port>\n                </replica>\n                <replica>\n                  <host>chi-wandb-clickhouse-0-1.clickhouse.svc.cluster.local</host> Update shard replica host\n                  <port>9000</port>\n                </replica>\n                <replica>\n                  <host>chi-wandb-clickhouse-0-2.clickhouse.svc.cluster.local</host> Update shard replica host\n                  <port>9000</port>\n                </replica>\n              </shard>\n            </weave_cluster>\n          </remote_servers>\n        </clickhouse>\n      config.d/storage_configuration.xml: |\n        <clickhouse>\n            <storage_configuration>\n                <disks>\n                    <s3_disk>\n                        <type>s3</type>\n                        <endpoint>https://storage.googleapis.com/wandbench-ch-1/{replica}</endpoint>\n                        <metadata_path>/var/lib/clickhouse/disks/s3_disk/</metadata_path>\n                        <use_environment_credentials>true</use_environment_credentials>\n                        <s3_use_virtual_hosted_style>false</s3_use_virtual_hosted_style>\n                    </s3_disk>\n                    <s3_disk_cache>\n                        <type>cache</type>\n                        <disk>s3_disk</disk>\n                        <path>/var/lib/clickhouse/s3_disk_cache/cache/</path>\n                        \x3c!-- THE CACHE SIZE MUST BE LOWER THAN PERSISTENT VOLUME --\x3e\n                        <max_size>40Gi</max_size>\n                        <cache_on_write_operations>true</cache_on_write_operations>\n                    </s3_disk_cache>\n                </disks>\n                <policies>\n                    <s3_main>\n                        <volumes>\n                            <main>\n                                <disk>s3_disk_cache</disk>\n                            </main>\n                        </volumes>\n                    </s3_main>\n                </policies>\n            </storage_configuration>\n            <merge_tree>\n                <storage_policy>s3_main</storage_policy>\n            </merge_tree>\n        </clickhouse>\n'})}),"\n",(0,t.jsx)(n.h3,{id:"confirm-clickhouse-deployment",children:"Confirm ClickHouse deployment"}),"\n",(0,t.jsx)(n.p,{children:"Confirm that ClickHouse is deployed using the following command:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get pods -n clickhouse\n"})}),"\n",(0,t.jsx)(n.p,{children:"The command returns the following pods:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"NAME                                                        READY   STATUS    RESTARTS   AGE\nch-operator-altinity-clickhouse-operator-56d6c46f49-nqqv7   2/2     Running   0          158m\nchi-wandb-clickhouse-0-0-0                                  1/1     Running   0          2m10s\nchi-wandb-clickhouse-0-1-0                                  1/1     Running   0          79s\nchi-wandb-clickhouse-0-2-0                                  1/1     Running   0          15s\nchk-wandb-keeper-0-0-0                                      1/1     Running   0          137m\nchk-wandb-keeper-0-1-0                                      1/1     Running   0          137m\nchk-wandb-keeper-0-2-0                                      1/1     Running   0          137m\n"})}),"\n",(0,t.jsx)(n.h2,{id:"2-add-clickhouse-configuration-in-wb-platform-cr",children:"2. Add ClickHouse Configuration in W&B Platform CR"}),"\n",(0,t.jsxs)(n.p,{children:["To integrate the ClickHouse database with W&B, edit the ",(0,t.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/operator/#complete-example",children:"CR instance"})," used to deploy the platform:"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Use Kubernetes service details to configure Weave tracing:"}),"\n"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Endpoint"}),": ",(0,t.jsx)(n.code,{children:"<release-name>-headless.<namespace>.svc.cluster.local"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Replace ",(0,t.jsx)(n.code,{children:"<release-name>"})," with your Helm release name"]}),"\n",(0,t.jsxs)(n.li,{children:["Replace ",(0,t.jsx)(n.code,{children:"<namespace>"})," with your ",(0,t.jsx)(n.code,{children:"NAMESPACE"})]}),"\n",(0,t.jsxs)(n.li,{children:["Get the service details: ",(0,t.jsx)(n.code,{children:"kubectl get svc -n <namespace>"})]}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Username"}),": Set in the ",(0,t.jsx)(n.code,{children:"values.yaml"})]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Password"}),": Set in the ",(0,t.jsx)(n.code,{children:"values.yaml"})]}),"\n"]}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"Using this information, update the W&B Platform Custom Resource(CR) by adding the following configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.wandb.com/v1\nkind: WeightsAndBiases\nmetadata:\n  labels:\n    app.kubernetes.io/name: weightsandbiases\n    app.kubernetes.io/instance: wandb\n  name: wandb\n  namespace: default\nspec:\n  values:\n    global:\n    [...]\n      clickhouse:\n        host: <release-name>-headless.<namespace>.svc.cluster.local\n        port: 8123\n        password: <password>\n        user: <username>\n        database: wandb_weave\n        # `replicated` must be set to `true` if replicating data across multiple nodes\n        # This is in preview, use the env var `WF_CLICKHOUSE_REPLICATED`\n        replicated: true\n\n      weave-trace:\n        enabled: true\n    [...]\n    weave-trace:\n      install: true\n      extraEnv:\n        WF_CLICKHOUSE_REPLICATED: "true"\n    [...]\n'})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(n.admonition,{type:"important",children:[(0,t.jsx)(n.p,{children:"When using more than one replica (W&B recommend a least 3 replicas), ensure to have the following environment variable set for Weave Traces."}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'extraEnv:\n  WF_CLICKHOUSE_REPLICATED: "true"\n'})}),(0,t.jsxs)(n.p,{children:["This has the same effect as ",(0,t.jsx)(n.code,{children:"replicated: true"}),"."]})]}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsxs)(n.p,{children:["Set the ",(0,t.jsx)(n.code,{children:"clusterName"})," in ",(0,t.jsx)(n.code,{children:"values.yaml"})," to ",(0,t.jsx)(n.code,{children:"weave_cluster"}),". The database migration fails if you do not set this value correctly."]}),"\n",(0,t.jsxs)(n.p,{children:["If you want to set a different cluster name, you can set the ",(0,t.jsx)(n.code,{children:"WF_CLICKHOUSE_REPLICATED_CLUSTER"})," environment variable in ",(0,t.jsx)(n.code,{children:"weave-trace.extraEnv"})," to match the chosen name, as shown in the example below."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'[...]\n  clickhouse:\n    host: <release-name>-headless.<namespace>.svc.cluster.local\n    port: 8123\n    password: <password>\n    user: <username>\n    database: wandb_weave\n    # `replicated` must be set to `true` if replicating data across multiple nodes\n    # This is in preview, use the env var `WF_CLICKHOUSE_REPLICATED`\n    replicated: true\n\n  weave-trace:\n    enabled: true\n[...]\nweave-trace:\n  install: true\n  extraEnv:\n    WF_CLICKHOUSE_REPLICATED: "true"\n    WF_CLICKHOUSE_REPLICATED_CLUSTER: "different_cluster_name"\n[...]\n'})}),"\n",(0,t.jsx)(n.p,{children:"The final configuration looks like the following example:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.wandb.com/v1\nkind: WeightsAndBiases\nmetadata:\n  labels:\n    app.kubernetes.io/name: weightsandbiases\n    app.kubernetes.io/instance: wandb\n  name: wandb\n  namespace: default\nspec:\n  values:\n    global:\n      license: eyJhbGnUzaHgyQjQyQWhEU3...ZieKQ2x5GGfw\n      host: https://wandb.example.com\n\n      bucket:\n        name: abc-wandb-moving-pipefish\n        provider: gcs\n\n      mysql:\n        database: wandb_local\n        host: 10.218.0.2\n        name: wandb_local\n        password: 8wtX6cJHizAZvYScjDzZcUarK4zZGjpV\n        port: 3306\n        user: wandb\n\n      clickhouse:\n        host: <release-name>-headless.<namespace>.svc.cluster.local\n        port: 8123\n        password: <password>\n        user: <username>\n        database: wandb_weave\n        # This option must be true if replicating data across multiple nodes\n        replicated: true\n\n      weave-trace:\n        enabled: true\n\n    ingress:\n      annotations:\n        ingress.gcp.kubernetes.io/pre-shared-cert: abc-wandb-cert-creative-puma\n        kubernetes.io/ingress.class: gce\n        kubernetes.io/ingress.global-static-ip-name: abc-wandb-operator-address\n\n    weave-trace:\n      install: true\n      extraEnv:\n        WF_CLICKHOUSE_REPLICATED: "true"\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\n",(0,t.jsx)(n.p,{children:"With the Custom Resource (CR) prepared, apply the new configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f wandb.yaml\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"3-access-weave",children:"3. Access Weave"}),"\n",(0,t.jsxs)(n.p,{children:["Once the deployment is running, you can access it using W&B endpoint configured in the ",(0,t.jsx)(n.code,{children:"host"})," field. It shows the Weave licensing status as enabled."]}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.img,{alt:"Weave",src:s(18209).Z+"",width:"2864",height:"806"})})]})}function u(e={}){const{wrapper:n}={...(0,i.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},18209:(e,n,s)=>{s.d(n,{Z:()=>t});const t=s.p+"assets/images/weave-org-dashboard-d3aee451d4b1ecf846a605de9ba62131.png"},11151:(e,n,s)=>{s.d(n,{Z:()=>r,a:()=>o});var t=s(67294);const i={},a=t.createContext(i);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);