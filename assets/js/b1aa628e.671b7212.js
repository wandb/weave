"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[5625],{63932:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>t,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var i=s(85893),a=s(11151);const r={},t="W&B Weave Self-Managed",o={id:"guides/platform/weave-self-managed",title:"W&B Weave Self-Managed",description:"Weave on self-managed infrastructure is currently in Private Preview.",source:"@site/docs/guides/platform/weave-self-managed.md",sourceDirName:"guides/platform",slug:"/guides/platform/weave-self-managed",permalink:"/guides/platform/weave-self-managed",draft:!1,unlisted:!1,editUrl:"https://github.com/wandb/weave/blob/master/docs/docs/guides/platform/weave-self-managed.md",tags:[],version:"current",lastUpdatedAt:1749652482e3,frontMatter:{},sidebar:"documentationSidebar",previous:{title:"Platform & Security",permalink:"/guides/platform/"},next:{title:"Environment variables",permalink:"/guides/core-types/env-vars"}},l={},c=[{value:"Requirements",id:"requirements",level:2},{value:"1. Configure ClickHouse",id:"1-configure-clickhouse",level:2},{value:"Configure Helm repository",id:"configure-helm-repository",level:3},{value:"Create Helm Configuration",id:"create-helm-configuration",level:3},{value:"S3 endpoint configuration",id:"s3-endpoint-configuration",level:3},{value:"Provide S3 credentials",id:"provide-s3-credentials",level:3},{value:"Hardcode the configuration",id:"hardcode-the-configuration",level:4},{value:"Use environment variables or EC2 Metadata",id:"use-environment-variables-or-ec2-metadata",level:4},{value:"2. Install and deploy ClickHouse",id:"2-install-and-deploy-clickhouse",level:2},{value:"3. Confirm ClickHouse deployment",id:"3-confirm-clickhouse-deployment",level:2},{value:"4. Deploy Weave",id:"4-deploy-weave",level:2},{value:"5. Gather information",id:"5-gather-information",level:2},{value:"6. Access Weave",id:"6-access-weave",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"wb-weave-self-managed",children:"W&B Weave Self-Managed"}),"\n",(0,i.jsxs)(n.admonition,{type:"important",children:[(0,i.jsx)(n.p,{children:"Weave on self-managed infrastructure is currently in Private Preview."}),(0,i.jsxs)(n.p,{children:["For production environments, W&B strongly recommends using ",(0,i.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/hosting-options/dedicated_cloud",children:"W&B Dedicated Cloud"}),", where Weave is Generally Available."]}),(0,i.jsxs)(n.p,{children:["To deploy a production-grade, self-managed instance, contact ",(0,i.jsx)(n.code,{children:"support@wandb.com"}),"."]})]}),"\n",(0,i.jsx)(n.p,{children:"This guide explains how to deploy all the components required to run W&B Weave in a self-managed environment."}),"\n",(0,i.jsxs)(n.p,{children:["A key component of a self-managed Weave deployment is ",(0,i.jsx)(n.a,{href:"https://clickhouse.com/",children:"ClickHouseDB"}),", which the Weave application backend relies on."]}),"\n",(0,i.jsx)(n.p,{children:"Although the deployment process sets up a fully functional ClickHouseDB instance, you may need to take additional steps to ensure reliability and high availability for a production-ready environment."}),"\n",(0,i.jsx)(n.h2,{id:"requirements",children:"Requirements"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["W&B Platform installed. For more information, see the ",(0,i.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/hosting-options/self-managed/",children:"Self-Managed Deployment Guide"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://github.com/bitnami/charts/tree/main/bitnami/clickhouse",children:"Bitnami's ClickHouse Helm Chart"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["An S3 bucket pre-configured for ClickHouse storage. For configuration details, see ",(0,i.jsx)(n.a,{href:"#provide-s3-credentials",children:"Provide S3 Credentials"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Kubernetes Cluster Nodes with the following specifications:","\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"CPU: 8 cores"}),"\n",(0,i.jsx)(n.li,{children:"RAM: 64 GB"}),"\n",(0,i.jsx)(n.li,{children:"Disk: 200GB+"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["A Weave-enabled license from W&B. To request a license, please contact ",(0,i.jsx)(n.code,{children:"support@wandb.com"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{type:"tip",children:[(0,i.jsx)(n.mdxAdmonitionTitle,{}),(0,i.jsxs)(n.p,{children:["For a detailed reference architecture, see ",(0,i.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/self-managed/ref-arch/#models-and-weave",children:"https://docs.wandb.ai/guides/hosting/self-managed/ref-arch/"}),"."]})]}),"\n",(0,i.jsx)(n.h2,{id:"1-configure-clickhouse",children:"1. Configure ClickHouse"}),"\n",(0,i.jsxs)(n.p,{children:["The ClickHouse deployment in this document uses the ",(0,i.jsx)(n.a,{href:"https://bitnami.com/stack/clickhouse",children:"Bitnami ClickHouse"})," package."]}),"\n",(0,i.jsxs)(n.p,{children:["The Bitnami Helm chart provides good support for basic ClickHouse functionalities, particularly the use of ",(0,i.jsx)(n.a,{href:"https://clickhouse.com/docs/en/guides/sre/keeper/clickhouse-keeper",children:"ClickHouse Keeper"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"To configure Clickhouse, complete the following steps:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#configure-helm-repository",children:"Configure the Helm repository"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#create-helm-configuration",children:"Create Helm Configuration"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"#provide-s3-credentials",children:"Provide S3 credentials"})}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"configure-helm-repository",children:"Configure Helm repository"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add the Bitnami Helm repository:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"helm repo add bitnami https://charts.bitnami.com/bitnami"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Update the repository:"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"helm repo update"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"create-helm-configuration",children:"Create Helm Configuration"}),"\n",(0,i.jsxs)(n.p,{children:["The most critical part of the Helm configuration is the ClickHouse configuration, which is provided in XML format. Below is an example ",(0,i.jsx)(n.code,{children:"values.yaml"})," file with customizable parameters to suit your needs.\nTo make the configuration process easier, we have added comments in the relevant sections using the format ",(0,i.jsx)(n.code,{children:"\x3c!-- COMMENT --\x3e"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"Modify the following parameters:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"clusterName"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"auth.username"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.code,{children:"auth.password"})}),"\n",(0,i.jsx)(n.li,{children:"S3 bucket-related configurations"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["W&B recommends keeping the ",(0,i.jsx)(n.code,{children:"clusterName"})," value in ",(0,i.jsx)(n.code,{children:"values.yaml"})," set to ",(0,i.jsx)(n.code,{children:"weave_cluster"}),".  This is the expected cluster name when W&B Weave runs the database migration. If you need to use a different name, see the ",(0,i.jsxs)(n.a,{href:"#setting-clustername",children:["Setting ",(0,i.jsx)(n.code,{children:"clusterName"})]})," section for more information."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'## @param clusterName ClickHouse cluster name\nclusterName: weave_cluster\n\n## @param shards Number of ClickHouse shards to deploy\nshards: 1\n\n## @param replicaCount Number of ClickHouse replicas per shard to deploy\n## if keeper enable, same as keeper count, keeper cluster by shards.\nreplicaCount: 3\n\npersistence:\n  enabled: true\n  size: 30G # this size must be larger than cache size.\n\n## ClickHouse resource requests and limits\nresources:\n  requests:\n    cpu: 0.5\n    memory: 500Mi\n  limits:\n    cpu: 3.0\n    memory: 6Gi\n\n## Authentication\nauth:\n  username: weave_admin\n  password: "weave_123"\n  existingSecret: ""\n  existingSecretKey: ""\n\n## @param logLevel Logging level\nlogLevel: information\n\n## @section ClickHouse keeper configuration parameters\nkeeper:\n  enabled: true\n\n## @param extraEnvVars Array with extra environment variables to add to ClickHouse nodes\n##\nextraEnvVars:\n  - name: S3_ENDPOINT\n    value: "https://s3.us-east-1.amazonaws.com/bucketname/$(CLICKHOUSE_REPLICA_ID)"\n\n\n## @param defaultConfigurationOverrides [string] Default configuration overrides (evaluated as a template)\ndefaultConfigurationOverrides: |\n  <clickhouse>\n    \x3c!-- Macros --\x3e\n    <macros>\n      <shard from_env="CLICKHOUSE_SHARD_ID"></shard>\n      <replica from_env="CLICKHOUSE_REPLICA_ID"></replica>\n    </macros>\n    \x3c!-- Log Level --\x3e\n    <logger>\n      <level>{{ .Values.logLevel }}</level>\n    </logger>\n    {{- if or (ne (int .Values.shards) 1) (ne (int .Values.replicaCount) 1)}}\n    <remote_servers>\n      <{{ .Values.clusterName }}>\n        {{- $shards := $.Values.shards | int }}\n        {{- range $shard, $e := until $shards }}\n        <shard>\n          <internal_replication>true</internal_replication>\n          {{- $replicas := $.Values.replicaCount | int }}\n          {{- range $i, $_e := until $replicas }}\n          <replica>\n            <host>{{ printf "%s-shard%d-%d.%s.%s.svc.%s" (include "common.names.fullname" $ ) $shard $i (include "clickhouse.headlessServiceName" $) (include "common.names.namespace" $) $.Values.clusterDomain }}</host>\n            <port>{{ $.Values.service.ports.tcp }}</port>\n          </replica>\n          {{- end }}\n        </shard>\n        {{- end }}\n      </{{ .Values.clusterName }}>\n    </remote_servers>\n    {{- end }}\n    {{- if .Values.keeper.enabled }}\n    <keeper_server>\n      <tcp_port>{{ $.Values.containerPorts.keeper }}</tcp_port>\n      {{- if .Values.tls.enabled }}\n      <tcp_port_secure>{{ $.Values.containerPorts.keeperSecure }}</tcp_port_secure>\n      {{- end }}\n      <server_id from_env="KEEPER_SERVER_ID"></server_id>\n      <log_storage_path>/bitnami/clickhouse/keeper/coordination/log</log_storage_path>\n      <snapshot_storage_path>/bitnami/clickhouse/keeper/coordination/snapshots</snapshot_storage_path>\n      <coordination_settings>\n        <operation_timeout_ms>10000</operation_timeout_ms>\n        <session_timeout_ms>30000</session_timeout_ms>\n        <raft_logs_level>trace</raft_logs_level>\n      </coordination_settings>\n      <raft_configuration>\n        {{- $nodes := .Values.replicaCount | int }}\n        {{- range $node, $e := until $nodes }}\n        <server>\n          <id>{{ $node | int }}</id>\n          <hostname from_env="{{ printf "KEEPER_NODE_%d" $node }}"></hostname>\n          <port>{{ $.Values.service.ports.keeperInter }}</port>\n        </server>\n        {{- end }}\n      </raft_configuration>\n    </keeper_server>\n    {{- end }}\n    {{- if or .Values.keeper.enabled .Values.zookeeper.enabled .Values.externalZookeeper.servers }}\n    <zookeeper>\n      {{- if or .Values.keeper.enabled }}\n      {{- $nodes := .Values.replicaCount | int }}\n      {{- range $node, $e := until $nodes }}\n      <node>\n        <host from_env="{{ printf "KEEPER_NODE_%d" $node }}"></host>\n        <port>{{ $.Values.service.ports.keeper }}</port>\n      </node>\n      {{- end }}\n      {{- else if .Values.zookeeper.enabled }}\n      {{- $nodes := .Values.zookeeper.replicaCount | int }}\n      {{- range $node, $e := until $nodes }}\n      <node>\n        <host from_env="{{ printf "KEEPER_NODE_%d" $node }}"></host>\n        <port>{{ $.Values.zookeeper.service.ports.client }}</port>\n      </node>\n      {{- end }}\n      {{- else if .Values.externalZookeeper.servers }}\n      {{- range $node :=.Values.externalZookeeper.servers }}\n      <node>\n        <host>{{ $node }}</host>\n        <port>{{ $.Values.externalZookeeper.port }}</port>\n      </node>\n      {{- end }}\n      {{- end }}\n    </zookeeper>\n    {{- end }}\n    {{- if .Values.metrics.enabled }}\n    <prometheus>\n      <endpoint>/metrics</endpoint>\n      <port from_env="CLICKHOUSE_METRICS_PORT"></port>\n      <metrics>true</metrics>\n      <events>true</events>\n      <asynchronous_metrics>true</asynchronous_metrics>\n    </prometheus>\n    {{- end }}\n    <listen_host>0.0.0.0</listen_host>\n    <listen_host>::</listen_host>\n    <listen_try>1</listen_try>\n    <storage_configuration>\n      <disks>\n        <s3_disk>\n          <type>s3</type>\n          <endpoint from_env="S3_ENDPOINT"></endpoint>\n\n          \x3c!-- AVOID USE CREDENTIALS CHECK THE RECOMMENDATION --\x3e\n          <access_key_id>xxx</access_key_id>\n          <secret_access_key>xxx</secret_access_key>\n          \x3c!-- AVOID USE CREDENTIALS CHECK THE RECOMMENDATION --\x3e\n\n         <metadata_path>/var/lib/clickhouse/disks/s3_disk/</metadata_path>\n        </s3_disk>\n        <s3_disk_cache>\n  \t      <type>cache</type>\n          <disk>s3_disk</disk>\n          <path>/var/lib/clickhouse/s3_disk_cache/cache/</path>\n          \x3c!-- THE CACHE SIZE MUST BE LOWER THAN PERSISTENT VOLUME --\x3e\n          <max_size>20Gi</max_size>\n        </s3_disk_cache>\n      </disks>\n      <policies>\n        <s3_main>\n          <volumes>\n            <main>\n              <disk>s3_disk_cache</disk>\n            </main>\n          </volumes>\n        </s3_main>\n      </policies>\n    </storage_configuration>\n    <merge_tree>\n      <storage_policy>s3_main</storage_policy>\n    </merge_tree>\n  </clickhouse>\n\n## @section Zookeeper subchart parameters\nzookeeper:\n  enabled: false\n'})}),"\n",(0,i.jsx)(n.h3,{id:"s3-endpoint-configuration",children:"S3 endpoint configuration"}),"\n",(0,i.jsx)(n.p,{children:"The bucket endpoint must be set as an environment variable to ensure each ClickHouse replica read and writes data in it's folder in the bucket."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'extraEnvVars:\n  - name: S3_ENDPOINT\n    value: "https://s3.us-east-1.amazonaws.com/bucketname/$(CLICKHOUSE_REPLICA_ID)"\n'})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["Do not remove the ",(0,i.jsx)(n.code,{children:"$(CLICKHOUSE_REPLICA_ID)"})," from the bucket endpoint configuration. It will ensure each ClickHouse replica is writing and reading data from it's folder in the bucket."]})}),"\n",(0,i.jsx)(n.h3,{id:"provide-s3-credentials",children:"Provide S3 credentials"}),"\n",(0,i.jsx)(n.p,{children:"You can specify credentials for accessing an S3 bucket by either hardcoding the configuration, or having ClickHouse fetch the data from environment variables or an EC2 instance."}),"\n",(0,i.jsx)(n.h4,{id:"hardcode-the-configuration",children:"Hardcode the configuration"}),"\n",(0,i.jsx)(n.p,{children:"Directly include the credentials in the storage configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:'<type>s3</type>\n<endpoint from_env="S3_ENDPOINT"></endpoint>\n<access_key_id>xxx</access_key_id>\n<secret_access_key>xxx</secret_access_key>\n'})}),"\n",(0,i.jsx)(n.h4,{id:"use-environment-variables-or-ec2-metadata",children:"Use environment variables or EC2 Metadata"}),"\n",(0,i.jsx)(n.p,{children:"Instead of hardcoding credentials, you can enable ClickHouse to fetch them dynamically from environment variables or Amazon EC2 instance metadata."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:"<use_environment_credentials>true</use_environment_credentials>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["You can find more details on this at ",(0,i.jsx)(n.a,{href:"https://clickhouse.com/docs/en/guides/separation-storage-compute",children:"ClickHouse: Separation of Storage and Compute"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"2-install-and-deploy-clickhouse",children:"2. Install and deploy ClickHouse"}),"\n",(0,i.jsxs)(n.p,{children:["With the repositories set up and the ",(0,i.jsx)(n.code,{children:"values.yaml"})," file prepared, the next step is to install ClickHouse."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"helm install clickhouse bitnami/clickhouse -f values.yaml --version 8.0.10\n"})}),"\n",(0,i.jsx)(n.admonition,{type:"important",children:(0,i.jsxs)(n.p,{children:["Ensure you're using the version ",(0,i.jsx)(n.code,{children:"8.0.10"}),". The latest chart version (",(0,i.jsx)(n.code,{children:"9.0.0"}),") doesn't work with the configuration proposed in this document."]})}),"\n",(0,i.jsx)(n.h2,{id:"3-confirm-clickhouse-deployment",children:"3. Confirm ClickHouse deployment"}),"\n",(0,i.jsx)(n.p,{children:"Confirm that ClickHouse is deployed using the following command:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl get pods\n"})}),"\n",(0,i.jsx)(n.p,{children:"You should see the following pods:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"NAME                                 READY   STATUS    RESTARTS   AGE\nclickhouse-shard0-0                  1/1     Running   0          9m59s\nclickhouse-shard0-1                  1/1     Running   0          10m\nclickhouse-shard0-2                  1/1     Running   0          10m\n"})}),"\n",(0,i.jsx)(n.h2,{id:"4-deploy-weave",children:"4. Deploy Weave"}),"\n",(0,i.jsxs)(n.p,{children:["Weave is already available for automatic deployment via ",(0,i.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/operator/#wb-kubernetes-operator",children:"W&B Operator"}),". With the W&B Platform installed, complete the following steps:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Edit the ",(0,i.jsx)(n.a,{href:"https://docs.wandb.ai/guides/hosting/operator/#complete-example",children:"CR instance"})," used to deploy the platform."]}),"\n",(0,i.jsx)(n.li,{children:"Add the Weave configuration."}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"5-gather-information",children:"5. Gather information"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Use Kubernetes service details to configure Weave tracing:"}),"\n"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Endpoint"}),": ",(0,i.jsx)(n.code,{children:"<release-name>-headless.<namespace>.svc.cluster.local"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["Replace ",(0,i.jsx)(n.code,{children:"<release-name>"})," with your Helm release name"]}),"\n",(0,i.jsxs)(n.li,{children:["Replace ",(0,i.jsx)(n.code,{children:"<namespace>"})," with your ",(0,i.jsx)(n.code,{children:"NAMESPACE"})]}),"\n",(0,i.jsxs)(n.li,{children:["Get the service details: ",(0,i.jsx)(n.code,{children:"kubectl get svc -n <namespace>"})]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Username"}),": Set in the ",(0,i.jsx)(n.code,{children:"values.yaml"})]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Password"}),": Set in the ",(0,i.jsx)(n.code,{children:"values.yaml"})]}),"\n"]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"With this information, update the W&B Platform Custom Resource(CR) by adding the following configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.wandb.com/v1\nkind: WeightsAndBiases\nmetadata:\n  labels:\n    app.kubernetes.io/name: weightsandbiases\n    app.kubernetes.io/instance: wandb\n  name: wandb\n  namespace: default\nspec:\n  values:\n    global:\n    [...]\n      clickhouse:\n        host: <release-name>-headless.<namespace>.svc.cluster.local\n        port: 8123\n        password: <password>\n        user: <username>\n        database: wandb_weave\n        # `replicated` must be set to `true` if replicating data across multiple nodes\n        # This is in preview, use the env var `WF_CLICKHOUSE_REPLICATED`\n        replicated: true\n\n      weave-trace:\n        enabled: true\n    [...]\n    weave-trace:\n      install: true\n      extraEnv:\n        WF_CLICKHOUSE_REPLICATED: "true"\n    [...]\n'})}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.admonition,{type:"important",children:[(0,i.jsx)(n.p,{children:"When using more than one replica (W&B recommend a least 3 replicas), ensure to have the following environment variable set for Weave Traces."}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'extraEnv:\n  WF_CLICKHOUSE_REPLICATED: "true"\n'})}),(0,i.jsxs)(n.p,{children:["This has the same effect of ",(0,i.jsx)(n.code,{children:"replicated: true"})," which in preview."]})]}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Set the ",(0,i.jsx)(n.code,{children:"clusterName"})," in ",(0,i.jsx)(n.code,{children:"values.yaml"})," to ",(0,i.jsx)(n.code,{children:"weave_cluster"}),". If it is not, the database migration will fail."]}),"\n",(0,i.jsxs)(n.p,{children:["Alternatively, ff you use a different cluster name, set the ",(0,i.jsx)(n.code,{children:"WF_CLICKHOUSE_REPLICATED_CLUSTER"})," environment variable in ",(0,i.jsx)(n.code,{children:"weave-trace.extraEnv"})," to match the chosen name, as shown in the example below."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'[...]\n  clickhouse:\n    host: <release-name>-headless.<namespace>.svc.cluster.local\n    port: 8123\n    password: <password>\n    user: <username>\n    database: wandb_weave\n    # `replicated` must be set to `true` if replicating data across multiple nodes\n    # This is in preview, use the env var `WF_CLICKHOUSE_REPLICATED`\n    replicated: true\n\n  weave-trace:\n    enabled: true\n[...]\nweave-trace:\n  install: true\n  extraEnv:\n    WF_CLICKHOUSE_REPLICATED: "true"\n    WF_CLICKHOUSE_REPLICATED_CLUSTER: "different_cluster_name"\n[...]\n'})}),"\n",(0,i.jsx)(n.p,{children:"The final configuration will look like the following example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps.wandb.com/v1\nkind: WeightsAndBiases\nmetadata:\n  labels:\n    app.kubernetes.io/name: weightsandbiases\n    app.kubernetes.io/instance: wandb\n  name: wandb\n  namespace: default\nspec:\n  values:\n    global:\n      license: eyJhbGnUzaHgyQjQyQWhEU3...ZieKQ2x5GGfw\n      host: https://wandb.example.com\n\n      bucket:\n        name: abc-wandb-moving-pipefish\n        provider: gcs\n\n      mysql:\n        database: wandb_local\n        host: 10.218.0.2\n        name: wandb_local\n        password: 8wtX6cJHizAZvYScjDzZcUarK4zZGjpV\n        port: 3306\n        user: wandb\n\n      clickhouse:\n        host: <release-name>-headless.<namespace>.svc.cluster.local\n        port: 8123\n        password: <password>\n        user: <username>\n        database: wandb_weave\n        # This option must be true if replicating data across multiple nodes\n        replicated: true\n\n      weave-trace:\n        enabled: true\n\n    ingress:\n      annotations:\n        ingress.gcp.kubernetes.io/pre-shared-cert: abc-wandb-cert-creative-puma\n        kubernetes.io/ingress.class: gce\n        kubernetes.io/ingress.global-static-ip-name: abc-wandb-operator-address\n\n    weave-trace:\n      install: true\n      extraEnv:\n        WF_CLICKHOUSE_REPLICATED: "true"\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"With the Custom Resource (CR) prepared, apply the new configuration:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f wandb.yaml\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"6-access-weave",children:"6. Access Weave"}),"\n",(0,i.jsxs)(n.p,{children:["Once the deployment is running, accessing the W&B endpoint configured in the ",(0,i.jsx)(n.code,{children:"host"})," option should display the Weave licensing status as enabled."]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.img,{alt:"Weave",src:s(18209).Z+"",width:"2864",height:"806"})})]})}function h(e={}){const{wrapper:n}={...(0,a.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},18209:(e,n,s)=>{s.d(n,{Z:()=>i});const i=s.p+"assets/images/weave-org-dashboard-808eee0637ab9a486d58f0a17adeb44d.png"},11151:(e,n,s)=>{s.d(n,{Z:()=>o,a:()=>t});var i=s(67294);const a={},r=i.createContext(a);function t(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:t(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);